<!DOCTYPE html>

<html>
<head>
  <title>collect.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="answer.html">
                answer.js
              </a>
            
              
              <a class="source" href="collect.html">
                collect.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="collect-js">collect.js</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="functions-to-process-and-collect-the-incoming-messages">Functions to process and collect the incoming messages</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><em>You can run this file like this: node collect.js input.txt
Where the lines of input.txt look like this:</em></p>
<pre><code>USERNAME;HH:MM 
<br />**OR**
<br />USERNAME;cancel</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><br /></p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Global variable <strong>store</strong>:
global variable in to store the subscribed people
the answer.js file needs this variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> store={};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>String formatting method to easily insert strings.
Source: <a href="http://stackoverflow.com/questions/610406/javascript-equivalent-to-printf-string-format">http://stackoverflow.com/questions/610406/javascript-equivalent-to-printf-string-format</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">String</span>.prototype.format) {
  <span class="hljs-built_in">String</span>.prototype.format = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.replace(<span class="hljs-regexp">/{(\d+)}/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, number)</span> </span>{ 
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> args[number] != <span class="hljs-string">'undefined'</span>
        ? args[number]
        : match
      ;
    });
  };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Function which has to be replaced if we merge it into hubot.
Its only purpose is to write the message on the console to check the output.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Reply</span><span class="hljs-params">(msg)</span>
</span>{
	<span class="hljs-built_in">console</span>.log(msg);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Function which has to be replaced if we merge it into hubot.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">throwError</span><span class="hljs-params">(location,msg)</span>
</span>{
	Reply(<span class="hljs-string">'ERROR in {0}, message: {1}'</span>.format(location,msg));
}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="main-function-">Main function,</h2>
<p>which parses the input string and stores, updates, deletes the store etc.. 
<br />@line: USER;HH:MM OR USER;cancel
<br />checks if the message is time</p>
<ul>
<li>if it’s time, then checks if it’s in the right range (12:30-14:59)<ul>
<li>if the time is correct, then assigns the user of that time </li>
</ul>
</li>
<li>if it isn’t a time, checks if it’s a cancel message<ul>
<li>if it’s a cancel message and the user is in the store, deletes it, and confirms
<br />    all else branches are handled with error messages.</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">business_logic</span><span class="hljs-params">(line)</span>
</span>{

	<span class="hljs-keyword">var</span> splitted_line, name, msg;

    splitted_line=line.split(<span class="hljs-string">';'</span>);
    msg=splitted_line[<span class="hljs-number">1</span>];
    name=splitted_line[<span class="hljs-number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Is message a time value?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span>(<span class="hljs-regexp">/\d{1,2}:\d{1,2}/i</span>.test(msg))
	{
		<span class="hljs-keyword">var</span> hours,minutes;
		<span class="hljs-keyword">var</span> splitted_date=msg.split(<span class="hljs-string">':'</span>);
		hours=<span class="hljs-built_in">parseInt</span>(splitted_date[<span class="hljs-number">0</span>]);
		minutes=<span class="hljs-built_in">parseInt</span>(splitted_date[<span class="hljs-number">1</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Converts 12h format to 24h format</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (hours&gt;=<span class="hljs-number">0</span> &amp;&amp; hours&lt;<span class="hljs-number">3</span>)
		{
			hours+=<span class="hljs-number">12</span>;
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Checks the range</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (hours&lt;<span class="hljs-number">12</span> || hours&gt;<span class="hljs-number">14</span> || (hours===<span class="hljs-number">12</span> &amp;&amp; minutes&lt;<span class="hljs-number">30</span>) || minutes&lt;<span class="hljs-number">0</span> || <span class="hljs-number">59</span>&lt;minutes)
		{
			throwError(<span class="hljs-string">'datecheck'</span>,<span class="hljs-string">'date ({0}) does not fit in time interval: 12:30-14:59'</span>.format(msg));
		}
		<span class="hljs-keyword">else</span>
		{</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Rounds minutes to 15 minutes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			minutes=<span class="hljs-built_in">Math</span>.floor((minutes/<span class="hljs-number">15</span>))*<span class="hljs-number">15</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Store the user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> time=<span class="hljs-string">'{0}:{1}'</span>.format(hours.toString(),minutes.toString());</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Bug for 14:00 — was resulting in 14:0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (time.length &lt; <span class="hljs-number">5</span>){
				time += <span class="hljs-number">0</span>; 
			}

			store[name]=time;
			<span class="hljs-keyword">return</span> <span class="hljs-string">"Data successfully recorded."</span>
		}
	}
	<span class="hljs-keyword">else</span>
	{</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>If it’s not a time-message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
		<span class="hljs-keyword">if</span> (msg.toLowerCase()===<span class="hljs-string">'cancel'</span>)
		{
			<span class="hljs-keyword">if</span> (name <span class="hljs-keyword">in</span> store)
			{</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>If message is ‘cancel’ and the USER is in the store, it deletes the user.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">delete</span> store[name];
				Reply(<span class="hljs-string">"You successfully cancelled your lunch appointment."</span>)
			}
			<span class="hljs-keyword">else</span>
			{
				throwError(<span class="hljs-string">'Cancel lunch'</span>,<span class="hljs-string">"You cancelled the lunch, but you didn't had any appointment yet."</span>);
			}
		}
		<span class="hljs-keyword">else</span>
		{
			<span class="hljs-keyword">if</span> (msg.length==<span class="hljs-number">0</span>)
			{
				throwError(<span class="hljs-string">'dateParser'</span>,<span class="hljs-string">"Your message is empty"</span>);	
			}
			<span class="hljs-keyword">else</span>
			{			
				throwError(<span class="hljs-string">'dateParser'</span>,<span class="hljs-string">"I couldn't understand your message. you wrote: {0}"</span>.format(time));
			}
			
		}
	}
}

<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">module</span>.parent) {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h1 id="this-is-the-main-module">This is the main module</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre> 	<span class="hljs-keyword">var</span> inf=<span class="hljs-string">'input.txt'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>cmd argument parsing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	process.argv.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(val, index, array)</span> </span>{
	<span class="hljs-keyword">if</span> (index==<span class="hljs-number">2</span>)
	{
		inf=val;
	}
	});</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>File reading line-by-line</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>),
	    readline = <span class="hljs-built_in">require</span>(<span class="hljs-string">'readline'</span>);

	<span class="hljs-keyword">var</span> rd = readline.createInterface({
	    input: fs.createReadStream(inf),
	    output: process.stdout,
	    terminal: <span class="hljs-literal">false</span>
	});

	rd.on(<span class="hljs-string">'line'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(line)</span> </span>{
		<span class="hljs-keyword">if</span> (line.length&gt;<span class="hljs-number">0</span>)
		{
			business_logic(line);
		}
	});</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Event bindign after file read -&gt; test output.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	rd.on(<span class="hljs-string">'pause'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>
	</span>{ 
		<span class="hljs-keyword">for</span>(key <span class="hljs-keyword">in</span> store)
		{
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"lunchmate {0} timeslot: {1}"</span>.format(key,store[key]));
		}
	})
}</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>// ## For test ##
business_logic(‘Lilo;14:00’);
business_logic(‘Judit;14:00’);
business_logic(‘Matyas;14:00’);
business_logic(‘Eniko;14:00’);
business_logic(‘Ferenc;14:00’);
business_logic(‘Balazs;14:00’);
// console.log(store);</p>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>For Mocha unit test located in spec directory</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports.business_logic = business_logic;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
